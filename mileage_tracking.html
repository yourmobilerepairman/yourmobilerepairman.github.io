<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Your Mobile Repairman - Mileage Tracking</title>
    <meta name="robots" content="noindex">
    <link rel="icon" href="img/logo.png" sizes="32x32" type="image/png">
    <!-- custom.css -->
    <link rel="stylesheet" href="css/custom.css">
    <!-- bootstrap.min.css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- font-awesome -->
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
</head>

<body>
    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Track Mileage
            </div>
            <div class="card-body p-3">
                <form id="partsUsed">
                    <div class="form-group">
                        <label for="dateTraveled">Date Traveled:</label>
                        <input class="form-control" id="dateTraveled" name="dateTraveled" type="date" />
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea class="form-control" id="description" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="locations">Locations:</label>
                        <textarea class="form-control" id="locations" name="locations"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="travelType">Type:</label>
                        <select class="form-control" id="travelType" name="travelType">
                            <option selected value="Errand">Errand</option>
                            <option value="Job">Job</option>
                            <option value="Between Properties">Between Properties</option>
                            <option value="Free Assessment">Free Assessment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="totalMiles">Total Miles:</label>
                        <input class="form-control" id="totalMiles" name="totalMiles" step="0.01" type="number" value="0" />
                    </div>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Other Actions
            </div>
            <div class="card-body p-3">
                <button class="btn btn-info" id="generateReport" type="button">Generate Report</button>
                <button class="btn btn-danger" id="clearAllData" type="button">Clear All Data</button>
            </div>
        </div>
    </div>

    <div class="p-3" id="mileage"></div>

    <script src="js/ymr.js"></script>
    <script>
        const MILEAGE_STORAGE_KEY = "mileage";

        const params = new URLSearchParams(window.location.search);

        const dateTraveledInput = document.getElementById('dateTraveled');
        const generateReportBtn = document.getElementById('generateReport');
        const clearAllDataBtn = document.getElementById('clearAllData');

        const currentDate = new Date();
        const formattedDate = formatDate(currentDate, 'YYYY-MM-DD');

        dateTraveledInput.value = formattedDate;

        const renderMileage = () => {
            const mileageStorage = getMileageStorage();

            let html = `<table class="table">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Description</th>
                        <th scope="col">Locations</th>
                        <th scope="col">Type</th>
                        <th scope="col">Total Miles</th>
                        <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody>`;
            for (const { date, description, locations, travelType, totalMiles, uuid } of eachMileageRecord()) {
                html += `<tr>
                        <th scope="row">${date}</th>
                        <td>${formatMultiLinesForHtml(description)}</td>
                        <td>${formatMultiLinesForHtml(locations)}</td>
                        <td>${travelType}</td>
                        <td>${totalMiles} mi</td>
                        <td>
                            <button class="btn btn-danger" onclick="javascript:deleteMileageData('${uuid}')" type="button">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            }
            html += `
                </tbody>
            </table>`;

            document.getElementById('mileage').innerHTML = html;
        }

        const getMileageStorage = () => {
            const mileageStorageText = localStorage.getItem(MILEAGE_STORAGE_KEY);
            let mileageStorage;
            if (mileageStorageText) {
                try {
                    mileageStorage = JSON.parse(mileageStorageText);
                } catch (err) {
                    console.error('Failed to parse mileage storage:', `json=${mileageStorageText};`, 'error=', err);
                    mileageStorage = {};
                }
            } else {
                mileageStorage = {};
            }

            return mileageStorage;
        }

        const deleteMileageData = uuid => {
            if (confirm("Are you sure you want to delete this mileage record?")) {
                const mileageStorage = getMileageStorage();
                delete mileageStorage[uuid];
                localStorage.setItem(MILEAGE_STORAGE_KEY, JSON.stringify(mileageStorage));
                renderMileage();
            }
        }

        function* eachMileageRecord() {
            const mileageStorage = getMileageStorage();
            const records = Object.keys(mileageStorage)
                .map(uuid => ({ uuid, ...mileageStorage[uuid] }))
                .sort(sortByDate('date'))

            for (const record of records) {
                yield record;
            }
        }

        const partsUsedForm = document.getElementById('partsUsed');
        partsUsedForm.addEventListener('submit', evt => {
            evt.preventDefault();

            const descriptionInput = document.getElementById('description');
            const locationsInput = document.getElementById('locations');
            const travelTypeInput = document.getElementById('travelType');
            const totalMilesInput = document.getElementById('totalMiles');

            const description = descriptionInput.value.trim();
            const locations = locationsInput.value.trim();
            const travelType = travelTypeInput.value;
            const totalMiles = parseFloat(totalMilesInput.value || '0');

            if (description === '') {
                alert('Please enter a description');
                return;
            }

            if (locations === '') {
                alert('Please enter locations');
                return;
            }

            if (totalMiles === 0) {
                alert('Please enter total miles traveled');
                return;
            }

            const mileageStorage = getMileageStorage();
            const newMileageId = crypto.randomUUID();

            const mileageData = {
                date: formatDate(new Date(dateTraveledInput.value), 'MM/DD/YYYY'),
                description,
                locations,
                travelType,
                totalMiles,
            };

            mileageStorage[newMileageId] = mileageData;
            localStorage.setItem(MILEAGE_STORAGE_KEY, JSON.stringify(mileageStorage));

            descriptionInput.value = '';
            locationsInput.value = '';
            totalMilesInput.value = 0;

            alert('Saved');
            renderMileage();
        });

        generateReportBtn.addEventListener('click', evt => {
            const csvData = [
                [`"Date"`, `"Description"`, `"Locations"`, `"Type"`, `"Total Miles"`]
            ];

            for (const { date, description, locations, travelType, totalMiles, uuid } of eachMileageRecord()) {
                csvData.push([date, description, locations, travelType, totalMiles]);
            }

            downloadCsv(csvData, `mileage_report_${formattedDate}.csv`);

            if (confirm("Do you want to delete all local mileage data?")) {
                localStorage.setItem(MILEAGE_STORAGE_KEY, '{}');
                renderMileage();
            }
        });

        clearAllDataBtn.addEventListener('click', evt => {
            if (confirm('Mileage data will be lost forever. Are you sure?')) {
                localStorage.setItem(MILEAGE_STORAGE_KEY, '{}');
                renderMileage();
            }
        });

        renderMileage();
    </script>
</body>

</html>