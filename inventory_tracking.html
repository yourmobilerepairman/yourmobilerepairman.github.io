<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Your Mobile Repairman - Inventory Tracking</title>
    <meta name="robots" content="noindex">
    <link rel="icon" href="img/logo.png" sizes="32x32" type="image/png">
    <!-- custom.css -->
    <link rel="stylesheet" href="css/custom.css">
    <!-- bootstrap.min.css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- font-awesome -->
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
</head>

<body>
    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Track Parts Used
            </div>
            <div class="card-body p-3">
                <form id="partsUsed">
                    <div class="form-group">
                        <label for="partId">Part ID:</label>
                        <input class="form-control" id="partId" name="partId" type="number" />
                    </div>
                    <div class="form-group">
                        <label for="invoiceId">Invoice ID:</label>
                        <input class="form-control" id="invoiceId" name="invoiceId" placeholder="TBD" />
                    </div>
                    <div class="form-group">
                        <label for="quantityUsed">Quantity Used:</label>
                        <input class="form-control" id="quantityUsed" name="quantityUsed" type="number" value="0" />
                    </div>
                    <div class="form-group">
                        <label for="dateUsed">Date Used:</label>
                        <input class="form-control" id="dateUsed" name="dateUsed" type="date" />
                    </div>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Other Actions
            </div>
            <div class="card-body p-3">
                <button class="btn btn-info" id="generateReport" type="button">Generate Report</button>
                <button class="btn btn-danger" id="clearAllData" type="button">Clear All Data</button>
            </div>
        </div>
    </div>

    <div class="p-3" id="parts"></div>

    <script src="js/ymr.js"></script>
    <script>
        const INVENTORY_STORAGE_KEY = "inventory";

        const params = new URLSearchParams(window.location.search);

        const partIdInput = document.getElementById('partId');
        const dateUsedInput = document.getElementById('dateUsed');
        const generateReportBtn = document.getElementById('generateReport');
        const clearAllDataBtn = document.getElementById('clearAllData');

        let partId = params.get('partId');
        if (partId) {
            partIdInput.value = partId;
        }

        const currentDate = new Date();
        const formattedDate = formatDate(currentDate, 'YYYY-MM-DD');

        dateUsedInput.value = formattedDate;

        const renderParts = () => {
            const inventoryStorage = getInventoryStorage();

            let html = `<table class="table">
                <thead>
                    <tr>
                        <th scope="col">Invoice ID</th>
                        <th scope="col">Part ID</th>
                        <th scope="col">Quantity Used</th>
                        <th scope="col">Date Used</th>
                        <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody>`;
            for (const { invoiceId, partId, totalUsed, date } of eachInventoryRecord()) {
                html += `<tr>
                        <th scope="row">${invoiceId}</th>
                        <td>${partId}</td>
                        <td>${totalUsed}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-danger" onclick="javascript:deleteInventoryData('${invoiceId}', '${partId}', '${date}')" type="button">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            }
            html += `
                </tbody>
            </table>`;

            document.getElementById('parts').innerHTML = html;
        }

        const getInventoryStorage = () => {
            const inventoryStorageText = localStorage.getItem(INVENTORY_STORAGE_KEY);
            let inventoryStorage;
            if (inventoryStorageText) {
                try {
                    inventoryStorage = JSON.parse(inventoryStorageText);
                } catch (err) {
                    console.error('Failed to parse inventory storage:', 'json="', inventoryStorageText, '"; error="', err, '";');
                    inventoryStorage = {};
                }
            } else {
                inventoryStorage = {};
            }

            return inventoryStorage;
        }

        const deleteInventoryData = (invoiceId, partId, date) => {
            if (confirm("Are you sure you want to delete this inventory record?")) {
                const inventoryStorage = getInventoryStorage();

                let invoiceData;
                if (inventoryStorage[invoiceId]) {
                    invoiceData = inventoryStorage[invoiceId];
                } else {
                    invoiceData = {};
                }

                let partData;
                if (invoiceData[partId]) {
                    partData = invoiceData[partId];
                } else {
                    partData = {};
                }

                delete partData[date];

                invoiceData[partId] = partData;
                inventoryStorage[invoiceId] = invoiceData;
                localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventoryStorage));

                renderParts();
            }
        }

        function* eachInventoryRecord() {
            const inventoryStorage = getInventoryStorage();
            const records = Object
                .keys(inventoryStorage)
                .reduce((invoiceAccum, invoiceKey) => {
                    const invoiceData = inventoryStorage[invoiceKey];
                    Object.keys(invoiceData).forEach(partKey => {
                        const partData = invoiceData[partKey];
                        Object.keys(partData).forEach(dateKey => {
                            const totalUsed = partData[dateKey];

                            invoiceAccum.push({
                                invoiceId: invoiceKey,
                                partId: partKey,
                                totalUsed,
                                date: dateKey
                            });
                        });
                    });

                    return invoiceAccum;
                }, [])
                .sort(sortByDate('date'));

            for (const record of records) {
                yield record;
            }
        }

        const partsUsedForm = document.getElementById('partsUsed');
        partsUsedForm.addEventListener('submit', evt => {
            evt.preventDefault();

            const quantityUsedInput = document.getElementById('quantityUsed');
            const invoiceIdInput = document.getElementById('invoiceId');

            partId = partIdInput.value.trim();

            const quantityUsed = parseInt(quantityUsedInput.value || '0');
            const invoiceId = invoiceIdInput.value || 'TBD';

            if (partId === '') {
                alert('Please enter a part ID');
                return;
            }

            if (quantityUsed === 0) {
                alert('Please enter a quantity');
                return;
            }

            const inventoryStorage = getInventoryStorage();

            let invoiceData;
            if (inventoryStorage[invoiceId]) {
                invoiceData = inventoryStorage[invoiceId];
            } else {
                invoiceData = {};
            }

            let partData;
            if (invoiceData[partId]) {
                partData = invoiceData[partId];
            } else {
                partData = {};
            }

            const selectedDate = formatDate(new Date(dateUsedInput.value), 'MM/DD/YYYY');
            if (typeof partData[selectedDate] === 'number') {
                partData[selectedDate] += quantityUsed;
            } else {
                partData[selectedDate] = quantityUsed;
            }

            invoiceData[partId] = partData;
            inventoryStorage[invoiceId] = invoiceData;
            localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventoryStorage));

            quantityUsedInput.value = 0;

            alert('Saved');
            renderParts();
        });

        generateReportBtn.addEventListener('click', evt => {
            const csvData = [
                [`"Invoice ID (Optional)"`, `"Purchase Part ID"`, `"Quantity Used"`, `"Date Used"`]
            ];

            for (const { invoiceId, partId, totalUsed, date } of eachInventoryRecord()) {
                csvData.push([invoiceId, partId, totalUsed, date]);
            }

            downloadCsv(csvData, `inventory_report_${formattedDate}.csv`);

            if (confirm("Do you want to delete all local inventory data?")) {
                localStorage.setItem(INVENTORY_STORAGE_KEY, '{}');
                renderParts();
            }
        });

        clearAllDataBtn.addEventListener('click', evt => {
            if (confirm('Inventory data will be lost forever. Are you sure?')) {
                localStorage.setItem(INVENTORY_STORAGE_KEY, '{}');
                renderParts();
            }
        });

        renderParts();
    </script>
</body>

</html>