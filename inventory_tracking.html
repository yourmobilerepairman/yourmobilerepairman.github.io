<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Your Mobile Repairman - Inventory Tracking</title>
    <meta name="description" content="Free bootstrap template Atlas">
    <link rel="icon" href="img/logo.png" sizes="32x32" type="image/png">
    <!-- custom.css -->
    <link rel="stylesheet" href="css/custom.css">
    <!-- bootstrap.min.css -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- font-awesome -->
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">

    <!-- AOS -->
    <link rel="stylesheet" href="css/aos.css">
</head>

<body>
    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Track Parts Used
            </div>
            <div class="card-body p-3">
                <form id="partsUsed">
                    <div class="form-group">
                        <label for="partNum">Part #:</label>
                        <input class="form-control" id="partNum" name="partNum" type="number" />
                    </div>
                    <div class="form-group">
                        <label for="numUsed">Total Used:</label>
                        <input class="form-control" id="numUsed" name="numUsed" type="number" />
                    </div>
                    <div class="form-group">
                        <label for="invoiceNum">Invoice #:</label>
                        <input class="form-control" id="invoiceNum" name="invoiceNum" placeholder="TBD" />
                    </div>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <div class="p-3">
        <div class="card">
            <div class="card-header">
                Other Actions
            </div>
            <div class="card-body p-3">
                <button class="btn btn-info" id="generateReport" type="button">Generate Report</button>
                <button class="btn btn-danger" id="clearAllData" type="button">Clear All Data</button>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);

        const partNumInput = document.getElementById('partNum');
        const generateReportBtn = document.getElementById('generateReport');
        const clearAllDataBtn = document.getElementById('clearAllData');

        let partNum = params.get('partNum');
        if (partNum) {
            partNumInput.value = partNum;
        }

        const partsUsedForm = document.getElementById('partsUsed');
        partsUsedForm.addEventListener('submit', evt => {
            evt.preventDefault();

            const numUsedInput = document.getElementById('numUsed');
            const invoiceNumInput = document.getElementById('invoiceNum');

            partNum = partNumInput.value;
            numUsed = numUsedInput.value;
            invoiceNum = invoiceNumInput.value || 'TBD';

            const currentInvoiceStorageText = localStorage.getItem(invoiceNum);
            let invoiceStorage;
            if (currentInvoiceStorageText) {
                invoiceStorage = JSON.parse(currentInvoiceStorageText);
            } else {
                invoiceStorage = {};
            }

            if (typeof invoiceStorage[partNum] === 'number') {
                invoiceStorage[partNum] += parseInt(numUsed);
            } else {
                invoiceStorage[partNum] = parseInt(numUsed);
            }

            localStorage.setItem(invoiceNum, JSON.stringify(invoiceStorage));

            partNumInput.value = '';
            numUsedInput.value = '';
        });

        generateReportBtn.addEventListener('click', evt => {
            const csvData = [
                [`"Invoice #"`, `"Part #"`, `"Total Used"`]
            ];

            Object.keys(localStorage).forEach(invoiceKey => {
                const invoiceData = JSON.parse(localStorage.getItem(invoiceKey));

                Object.keys(invoiceData).forEach(partKey => {
                    const totalPartUsed = invoiceData[partKey];

                    csvData.push([`"${invoiceKey}"`, `"${partKey}"`, `"${totalPartUsed}"`]);
                });
            });

            let csvContent = 'data:text/csv;charset=utf-8,';
            csvData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            console.log('csvContent:', csvContent);

            // Download the generated CSV content
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_report_${new Date().toString('YYYY-MM-DD')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        clearAllDataBtn.addEventListener('click', evt => {
            if (confirm('Data will be lost forever. Are you sure?')) {
                localStorage.clear();
            }
        });
    </script>
</body>

</html>